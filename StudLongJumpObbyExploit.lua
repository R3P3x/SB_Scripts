_G.AutoRebirth = false

local stagePositions = {["0"] = CFrame.new(-23.6470337, 3.00000072, -16.7945175),["1"] = CFrame.new(-56.6470337, 3.00000072, -16.7945175),["2"] = CFrame.new(-73.1470337, 3.00000072, -16.7945175),["3"] = CFrame.new(-90.14703369140625, 3.00000072, -16.7945175),["4"] = CFrame.new(-107.64703369140625, 3.00000072, -16.7945175),["5"] = CFrame.new(-125.64703369140625, 3.00000072, -16.7945175),  ["6"] = CFrame.new(-144.14703369140625, 3.00000072, -16.7945175),["7"] = CFrame.new(-163.14706420898438, 3.00000072, -16.7945175),    ["8"] = CFrame.new(-182.6470947265625, 3.00000072, -16.7945175),["9"] = CFrame.new(-202.64712524414062, 3.00000072, -16.7945175),["10"] = CFrame.new(-223.14715576171875, 3.00000072, -16.7945175),["11"] = CFrame.new(-244.14718627929688, 3.00000072, -16.7945175),["12"] = CFrame.new(-265.647216796875, 3.00000072, -16.7945175),["13"] = CFrame.new(-287.647216796875, 3.00000072, -16.7945175),["14"] = CFrame.new(-310.147216796875, 3.00000072, -16.7945175),["15"] = CFrame.new(-333.147216796875, 3.00000072, -16.7945175),["16"] = CFrame.new(-356.647216796875, 3.00000072, -16.7945175),["17"] = CFrame.new(-380.647216796875, 3.00000072, -16.7945175),["18"] = CFrame.new(-405.147216796875, 3.00000072, -16.7945175),["19"] = CFrame.new(-430.147216796875, 3.00000072, -16.7945175),["20"] = CFrame.new(-455.3971862792969, 3.00000072, -16.7945175),["21"] = CFrame.new(-480.8971862792969, 3.00000072, -16.7945175),["22"] = CFrame.new(-506.6471862792969, 3.00000072, -16.7945175),["23"] = CFrame.new(-532.647216796875, 3.00000072, -16.7945175),["24"] = CFrame.new(-558.897216796875, 3.00000072, -16.7945175),["25"] = CFrame.new(-585.397216796875, 3.00000072, -16.7945175),["26"] = CFrame.new(-612.147216796875, 3.00000072, -16.7945175),["27"] = CFrame.new(-639.147216796875, 3.00000072, -16.7945175),["28"] = CFrame.new(-666.397216796875, 3.00000072, -16.7945175),["29"] = CFrame.new(-693.897216796875, 3.00000072, -16.7945175),["30"] = CFrame.new(-721.647216796875, 3.00000072, -16.7945175),["31"] = CFrame.new(-749.647216796875, 3.00000072, -16.7945175),["32"] = CFrame.new(-777.897216796875, 3.00000072, -16.7945175),["33"] = CFrame.new(-806.397216796875, 3.00000072, -16.7945175),["34"] = CFrame.new(-835.147216796875, 3.00000072, -16.7945175),["35"] = CFrame.new(-864.147216796875, 3.00000072, -16.7945175),["36"] = CFrame.new(-893.2472534179688, 3.00000072, -16.7945175),["37"] = CFrame.new(-922.4472045898438, 3.00000072, -16.7945175),["38"] = CFrame.new(-951.7472534179688, 3.00000072, -16.7945175),["39"] = CFrame.new(-981.147216796875, 3.00000072, -16.7945175),["40"] = CFrame.new(-1010.6472778320312, 3.00000072, -16.7945175),["41"] = CFrame.new(-1040.247314453125, 3.00000072, -16.7945175),["42"] = CFrame.new(-1069.947265625, 3.00000072, -16.7945175),["43"] = CFrame.new(-1099.747314453125, 3.00000072, -16.7945175),["44"] = CFrame.new(-1129.647216796875, 3.00000072, -16.7945175),["45"] = CFrame.new(-1170.647216796875, 3.00000072, -16.7945175),["46"] = CFrame.new(-1311.747314453125, 3.00000072, -16.7945175),["47"] = CFrame.new(-1341.79736328125, 3.00000072, -16.7945175),["48"] = CFrame.new(-1371.8973388671875, 3.00000072, -16.7945175),["49"] = CFrame.new(-1402.04736328125, 3.00000072, -16.7945175),["50"] = CFrame.new(-1432.247314453125, 3.00000072, -16.7945175),["51"] = CFrame.new(-1462.497314453125, 3.00000072, -16.7945175)}
local checkpoints = game.Workspace.Checkpoints:GetChildren()

local stageRef = game.Players.LocalPlayer.leaderstats.Stage
local function realStage()
    return tonumber(game.Players.LocalPlayer.PlayerGui.StageTransfer.CurrentStage.Text)
end

local function getStage(direction)
    if direction == "up" then
        return realStage() + 1
    elseif direction == "down" then
        return realStage() - 1
    else return 0 end
end

local function touchNextStage()
    local nextStage = tostring(realStage() + 1)
    local nextCheckpoint = game.Workspace.Checkpoints:FindFirstChild(nextStage)
    if nextCheckpoint and game.Players.LocalPlayer.Character and game.Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        local hrp = game.Players.LocalPlayer.Character.HumanoidRootPart
        firetouchinterest(hrp, nextCheckpoint, true)
    else
        warn("Checkpoint or HRP not found for stage: " .. nextStage)
    end
end

oldNamecall = hookmetamethod(game, "__namecall", function(self, ...)
    local method = getnamecallmethod()
    local args = {...}

    if method == "FireServer" and self == game.ReplicatedStorage.StageTransfer then
        print("Intercepted StageTransfer RE: " .. table.concat(args, ", "))
        local stage = getStage(args[1])

        if stage > stageRef.Value then
            touchNextStage()
            local nextPos = stagePositions[tostring(stage)]
            if nextPos then
                game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = nextPos
            end
            task.wait(1)
            return
        end
        return oldNamecall(self, table.unpack(args))
    end
    return oldNamecall(self, table.unpack(args))
end)

stageRef.Changed:Connect(function()
    if _G.AutoRebirth == true and stageRef.Value >= 45 then
        game.ReplicatedStorage.RebirthEvent:FireServer()
    end
end)
